import "requests"
import "json"
ws = requests.makeWebsocket("wss://gateway.discord.gg/?v=6&encoding=json")

token = "Bot ODExMzE3MDEwNjQ1OTA5NTg0.YCwb2A.ZBhmsI0U-KQR7LVkWehDEoEEcAc"

connected = false
heartbeat = -1
lastS = -1
op messageHandler(msg) uses[connected, heartbeat, lastS] do {
    res = json.loads(msg)
    if typeOf(res["s"]) == "NUMBER" do {
        lastS = res["s"]
    }
    _op = res["op"]

    # Check the ops
    if _op == 10 do {
        heartbeat = res["d"]["heartbeat_interval"]
        if not connected do {
            connected = true
            heartbeat_p = {
                "op": 1,
                "d": json.NULL
            }
            ws.send(json.dumps(heartbeat_p))
            print("Connected")
        }

        sendId()
    } elif _op == 0 do {
        t = res["t"]
        if t == "READY" do {
            print(res["d"])
        } elif t == "MESSAGE_CREATE" do {
            print(res["d"]["content"])
        }
    }
}

op sendId() do {
    id = {
        "op": 2,
        "d": {
            "token": token,
            "properties": {
                "$os": "linux",
                "$browser": "chrome",
                "$device": "pc"
            },
            "intents": 513
        }
    }
    ws.send(json.dumps(id))
}

ws.setMessageHandler(messageHandler)

ws.start()

count = 0
while true do {
    count += 200
    if connected and heartbeat != -1 and count >= heartbeat do {
        count = 0
        p = '{"op": 1, "d": ' + lastS + '}'
        ws.send(p)
    }
}